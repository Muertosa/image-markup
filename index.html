<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="UTF-8">
  <title>Image Markup для Retouch Club</title>
  <style>
    body { font-family: sans-serif; background: #111; color: #fff; display: flex; flex-direction: column; align-items: center; }
    .container { margin: 24px 0; }
    .img-card { background: #222; padding: 18px; border-radius: 14px; margin: 20px 0; box-shadow: 0 4px 20px #0004; width: 650px; max-width: 98vw;}
    .img-card h3 { margin: 0 0 10px 0; font-weight: 400; }
    .canvas-wrap { position: relative; }
    canvas { border: 2px solid #888; background: #222; cursor: crosshair; }
    .controls { margin: 8px 0 14px 0; }
    .btn { background: #222; color: #fff; border: 1px solid #555; padding: 7px 16px; margin-right: 7px; border-radius: 6px; cursor: pointer; }
    .btn:hover { background: #333; }
    input[type="file"] { color: #fff; }
    .comment { width: 100%; min-height: 40px; margin: 12px 0 0 0; background: #191919; color: #fff; border: 1px solid #444; border-radius: 6px; font-size: 15px; padding: 8px; resize: vertical;}
    @media (max-width:700px) {
      .img-card { width: 100%; min-width: 0; }
      canvas { width: 95vw !important; }
    }
  </style>
</head>
<body>
  <h2>Image Markup для Retouch Club</h2>
  <div class="container">
    <input type="file" id="imgLoader" accept="image/*" multiple class="btn">
  </div>
  <div id="gallery"></div>
  <p style="max-width:480px; color:#aaa;">
    1. Загрузите несколько изображений.<br>
    2. Для каждого — сделайте пометки, напишите текст ТЗ.<br>
    3. Скачайте каждый файл с пометками (или все вручную).<br>
    <b>Автоматизацию отправки можно добавить позже.</b>
  </p>
  <script>
    function createCard(file, idx) {
      let card = document.createElement('div');
      card.className = 'img-card';

      let h3 = document.createElement('h3');
      h3.textContent = `Изображение ${idx+1}: ${file.name}`;
      card.appendChild(h3);

      // Controls
      let controls = document.createElement('div');
      controls.className = 'controls';

      // Color
      let colorLabel = document.createElement('label');
      colorLabel.innerHTML = 'Цвет: ';
      let colorInput = document.createElement('input');
      colorInput.type = 'color';
      colorInput.value = '#ff4444';
      colorInput.style.marginRight = "6px";
      colorLabel.appendChild(colorInput);

      // Size
      let sizeLabel = document.createElement('label');
      sizeLabel.innerHTML = 'Толщина: ';
      let sizeInput = document.createElement('input');
      sizeInput.type = 'number';
      sizeInput.value = 4;
      sizeInput.min = 1; sizeInput.max = 50;
      sizeInput.style.width = '40px';
      sizeLabel.appendChild(sizeInput);

      // Clear & Download
      let clearBtn = document.createElement('button');
      clearBtn.className = 'btn'; clearBtn.innerText = 'Очистить';
      let dlBtn = document.createElement('button');
      dlBtn.className = 'btn'; dlBtn.innerText = 'Скачать с пометками';

      controls.append(colorLabel, sizeLabel, clearBtn, dlBtn);
      card.appendChild(controls);

      // Canvas
      let canvasWrap = document.createElement('div');
      canvasWrap.className = 'canvas-wrap';
      let canvas = document.createElement('canvas');
      canvas.width = 600;
      canvas.height = 400;
      canvas.style.maxWidth = "95vw";
      let ctx = canvas.getContext('2d');
      canvasWrap.appendChild(canvas);
      card.appendChild(canvasWrap);

      // Текстовое поле для ТЗ
      let comment = document.createElement('textarea');
      comment.className = 'comment';
      comment.placeholder = "Ваши пожелания или подробное ТЗ для этого изображения";
      card.appendChild(comment);

      // Прочее
      let img = new window.Image();
      let drawing = false, lastX = 0, lastY = 0;
      let strokeColor = colorInput.value;
      let strokeWidth = parseInt(sizeInput.value);

      colorInput.onchange = e => strokeColor = e.target.value;
      sizeInput.onchange = e => strokeWidth = parseInt(e.target.value);

      // Прочитать изображение и подогнать canvas
      let reader = new FileReader();
      reader.onload = function(evt){
        img.onload = function(){
          let scale = Math.min(900/img.width, 600/img.height, 1);
          canvas.width = img.width * scale;
          canvas.height = img.height * scale;
          ctx.clearRect(0, 0, canvas.width, canvas.height);
          ctx.drawImage(img, 0, 0, canvas.width, canvas.height);
        }
        img.src = evt.target.result;
      }
      reader.readAsDataURL(file);

      // Рисование
      canvas.addEventListener('mousedown', function(e){
        drawing = true;
        [lastX, lastY] = [e.offsetX, e.offsetY];
      });
      canvas.addEventListener('mousemove', function(e){
        if (!drawing) return;
        ctx.strokeStyle = strokeColor;
        ctx.lineWidth = strokeWidth;
        ctx.lineCap = 'round';
        ctx.beginPath();
        ctx.moveTo(lastX, lastY);
        ctx.lineTo(e.offsetX, e.offsetY);
        ctx.stroke();
        [lastX, lastY] = [e.offsetX, e.offsetY];
      });
      canvas.addEventListener('mouseup', ()=> drawing = false);
      canvas.addEventListener('mouseleave', ()=> drawing = false);

      // Очистка
      clearBtn.onclick = function(){
        if (!img.src) return;
        ctx.clearRect(0,0,canvas.width,canvas.height);
        ctx.drawImage(img, 0, 0, canvas.width, canvas.height);
      };

      // Скачать
      dlBtn.onclick = function(){
        if (!img.src) return alert("Сначала загрузите изображение!");
        let link = document.createElement('a');
        link.download = file.name.replace(/\.\w+$/, '') + '_markup.png';
        link.href = canvas.toDataURL();
        link.click();
      };

      return card;
    }

    document.getElementById('imgLoader').addEventListener('change', function(e){
      let files = Array.from(e.target.files);
      let gallery = document.getElementById('gallery');
      gallery.innerHTML = ''; // очистить галерею перед новой загрузкой
      files.forEach((file, idx) => {
        if (!file.type.startsWith('image/')) return;
        let card = createCard(file, idx);
        gallery.appendChild(card);
      });
    });
  </script>
</body>
</html>
